#!/bin/bash
set -x
PWD=/app

# Delete everything but anvil build scripts
cp /app/bin/stow /tmp
rm -rf /app/*
mkdir /app/bin
mv /tmp/stow /app/bin

mkdir -p $PWD/apt/{archives/partial,lists/partial}
mkdir -p $PWD/vendor

cat >$PWD/apt/sources.list <<EOF
deb http://archive.ubuntu.com/ubuntu lucid main universe
deb http://archive.ubuntu.com/ubuntu lucid-security main
deb http://archive.ubuntu.com/ubuntu lucid-updates main

deb-src http://archive.ubuntu.com/ubuntu lucid main universe
deb-src http://archive.ubuntu.com/ubuntu lucid-security main
deb-src http://archive.ubuntu.com/ubuntu lucid-updates main
EOF

apt-get update                                                        \
  -o Dir::Cache=$PWD/apt -o Dir::Etc=$PWD/apt -o Dir::State=$PWD/apt

apt-get install --download-only --no-install-recommends --yes         \
  -o Dir::Cache=$PWD/apt -o Dir::Etc=$PWD/apt -o Dir::State=$PWD/apt  \
  fortune-mod fortunes-min

for deb in $PWD/apt/archives/*.deb; do
  dpkg -x $deb $PWD/vendor
done

rm -rf $PWD/apt